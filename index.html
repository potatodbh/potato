<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EconNation ‚Äî Race to Prosperity</title>

  <!-- Prevent favicon.ico console noise -->
  <link rel="icon" href="data:,">

  <style>
    :root { font-family: system-ui, Arial, sans-serif; }
    body { margin: 0; padding: 16px; background: #0b0d10; color: #e9eef5; }
    h1 { margin: 0 0 6px; font-size: 40px; letter-spacing: .2px; }
    .sub { opacity: .8; font-size: 14px; margin-bottom: 14px; }

    .wrap { display: grid; grid-template-columns: 1.25fr 0.75fr; gap: 14px; }
    .card {
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
    }

    .board{
      display:grid;
      grid-template-columns: repeat(10, minmax(92px, 1fr));
      gap: 10px;
      user-select: none;
      align-items: stretch;
    }
    @media (max-width: 1100px){
      .wrap { grid-template-columns: 1fr; }
      .board{ grid-template-columns: repeat(8, minmax(92px, 1fr)); }
    }
    @media (max-width: 650px){
      .board{ grid-template-columns: repeat(6, minmax(92px, 1fr)); }
    }

    .tile{
      min-height: 84px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      display:flex;
      flex-direction: column;
      justify-content: space-between;
      font-size: 12px;
      overflow: hidden;
    }

    .tile .idx { opacity: .65; font-size: 11px; }

    /* FIX: prevent weird wrap/cut for Decision etc */
    .tile .name{
      display:flex;
      align-items:center;
      gap: 8px;
      font-weight: 900;
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
    }
    .tile .icon{ flex: 0 0 auto; }
    .tile .label{
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Color accents per tile type */
    .tile.decision { border-color: rgba(244, 63, 94, .35); box-shadow: 0 0 0 1px rgba(244,63,94,.08) inset; }
    .tile.quiz     { border-color: rgba(168, 85, 247, .35); box-shadow: 0 0 0 1px rgba(168,85,247,.08) inset; }
    .tile.policy   { border-color: rgba(250, 204, 21, .35); box-shadow: 0 0 0 1px rgba(250,204,21,.08) inset; }
    .tile.market   { border-color: rgba(34, 197, 94, .35); box-shadow: 0 0 0 1px rgba(34,197,94,.08) inset; }
    .tile.trade    { border-color: rgba(59, 130, 246, .35); box-shadow: 0 0 0 1px rgba(59,130,246,.08) inset; }
    .tile.bonus    { border-color: rgba(249, 115, 22, .35); box-shadow: 0 0 0 1px rgba(249,115,22,.08) inset; }
    .tile.risk     { border-color: rgba(255, 255, 255, .20); box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset; }

    .tile.active {
      outline: 2px solid rgba(255,255,255,.65);
      box-shadow: 0 0 0 5px rgba(255,255,255,.06), 0 18px 28px rgba(0,0,0,.30);
    }

    .tile.finish {
      background: linear-gradient(135deg, rgba(255,215,0,.18), rgba(255,255,255,.04));
      border-color: rgba(255,215,0,.35);
    }
    .tile.start {
      background: linear-gradient(135deg, rgba(96,165,250,.18), rgba(255,255,255,.04));
      border-color: rgba(96,165,250,.35);
    }

    .token { display:inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 6px; border: 1px solid rgba(255,255,255,.25); }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }

    button { border: 0; border-radius: 14px; padding: 10px 12px; cursor: pointer; }
    .btn { background: #fff; color: #111; box-shadow: 0 8px 18px rgba(0,0,0,.35); }
    .btn2 { background: rgba(255,255,255,.06); color: #fff; border: 1px solid rgba(255,255,255,.14); }
    button:disabled { opacity: .5; cursor: not-allowed; }

    .pill {
      display:inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.92);
    }

    .small { font-size: 12px; opacity: .82; }
    .choice { display:grid; gap: 10px; margin-top: 10px; }

    #eventBox{
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
    }

    /* Neater log */
    .log {
      max-height: 280px;
      overflow:auto;
      font-size: 12px;
      line-height: 1.35;
      background: rgba(255,255,255,.02);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 8px 10px;
    }
    .log-item{
      padding: 8px 0;
      border-bottom: 1px dashed rgba(255,255,255,.10);
    }
    .log-item:last-child{ border-bottom: none; }
    .log-top{
      display:flex;
      align-items:flex-start;
      gap:10px;
    }
    .log-ico{ width:22px; opacity:.95; }
    .log-title{ font-weight: 800; letter-spacing:.1px; }
    .log-detail{ opacity:.82; margin-top:2px; }

    .stat-card {
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 12px;
      margin-bottom: 10px;
    }
    .stat-head { display:flex; justify-content:space-between; align-items:center; gap: 10px; }
    .stat-name { font-weight: 900; letter-spacing: .2px; }

    hr { border: none; border-top: 1px solid rgba(255,255,255,.10); margin: 12px 0; }

    /* ---------- Rules Modal ---------- */
    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.62);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 16px;
    }
    .modal {
      width: min(920px, 96vw);
      max-height: 86vh;
      overflow: auto;
      background: #0b0d10;
      color: #fff;
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
    }
    .modal-header {
      position: sticky;
      top: 0;
      background: #0b0d10;
      padding: 14px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .modal-title { font-size: 18px; font-weight: 900; }
    .modal-x {
      appearance: none; border: 0; background: transparent;
      color: #fff; font-size: 22px; cursor: pointer; opacity: .85;
    }
    .modal-x:hover { opacity: 1; }
    .modal-body { padding: 14px 16px 16px; line-height: 1.35; font-size: 14px; color: rgba(255,255,255,.92); }
    .rules-grid { display: grid; gap: 10px; grid-template-columns: 1fr 1fr; }
    @media (max-width: 800px) { .rules-grid { grid-template-columns: 1fr; } }
    .rules-card {
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .modal-footer {
      padding: 12px 16px 16px;
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      border-top: 1px solid rgba(255,255,255,.10);
    }
    .modal-footer .left { display:flex; gap:10px; align-items:center; color: rgba(255,255,255,.85); font-size: 13px; }
    .modal-footer .right { display:flex; gap:10px; }
    .btn-modal {
      border-radius: 12px;
      padding: 10px 12px;
      cursor: pointer;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: #fff;
    }
    .btn-modal.primary { background: #fff; color: #111; border-color: transparent; }
  </style>
</head>

<body>
  <h1>EconNation</h1>
  <div class="sub">Race to the finish by making smart economic choices. Designed for ~20 minutes of play.</div>

  <div class="wrap">
    <div class="card">
      <h2 style="margin:0 0 10px;">Board</h2>
      <div id="board" class="board"></div>

      <div class="row" style="margin-top:12px;">
        <button id="rollBtn" class="btn">Roll Dice</button>
        <button id="rulesBtn" class="btn2">Rules</button>

        <span class="pill" id="diceOut">Dice: ‚Äî</span>
        <span class="pill" id="progressOut">Progress: 0 / 59</span>
        <span class="pill" id="turnOut">Turn: Player 1</span>
        <span class="pill" id="goalOut">Goal: Finish + Prosperity ‚â• 15</span>
      </div>

      <div class="small" style="margin-top:10px;">
        Tip: High GDP is good, but watch unemployment + inflation + inequality. Cash helps you survive shocks.
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px;">Dashboard</h2>
      <div id="stats"></div>

      <hr>

      <h3 style="margin:0 0 6px;">Tile</h3>
      <div id="eventBox" class="small">Roll to begin.</div>
      <div id="choices" class="choice"></div>

      <hr>

      <h3 style="margin:0 0 6px;">Game Log</h3>
      <div id="log" class="log"></div>
    </div>
  </div>

  <!-- Rules Modal -->
  <div id="rulesModal" class="modal-backdrop" style="display:none;">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="rulesTitle">
      <div class="modal-header">
        <div class="modal-title" id="rulesTitle">How to Play ‚Äî EconNation</div>
        <button class="modal-x" id="rulesCloseX" aria-label="Close rules">√ó</button>
      </div>

      <div class="modal-body">
        <div class="rules-grid">
          <div class="rules-card">
            <strong>Goal</strong>
            <div style="margin-top:6px;">
              Race to the <strong>Finish</strong> tile. To win, you must reach the finish and have
              <strong>Prosperity Score ‚â• 15</strong>.
            </div>
          </div>

          <div class="rules-card">
            <strong>What Prosperity means</strong>
            <div style="margin-top:6px;">
              Prosperity Score rewards <em>growth + stability</em>.
              It goes up with strong <strong>GDP</strong> and smart choices, and goes down when
              <strong>unemployment</strong>, <strong>inflation (CPI)</strong>, or <strong>inequality</strong> get out of control.
            </div>
          </div>

          <div class="rules-card">
            <strong>Your Turn</strong>
            <ol style="margin:6px 0 0 18px;">
              <li>Click <strong>Roll Dice</strong></li>
              <li>Move to a tile</li>
              <li>Answer the prompt (A/B) or quick quiz</li>
              <li>Stats update immediately (and sometimes later)</li>
            </ol>
          </div>

          <div class="rules-card">
            <strong>Tile Types</strong>
            <div style="margin-top:6px;">
              ‚ùì Decision ‚Ä¢ üß† Quick Quiz ‚Ä¢ ‚öñÔ∏è Policy ‚Ä¢ üì¶ Market ‚Ä¢ üåç Trade ‚Ä¢ üí∞ Bonus ‚Ä¢ üé≤ Risk ‚Ä¢ üèÅ Start ‚Ä¢ üèÜ Finish
            </div>
          </div>

          <div class="rules-card">
            <strong>Course Connection (CIE3M)</strong>
            <div style="margin-top:6px;">
              Scenarios cover scarcity/opportunity cost, supply &amp; demand, price controls, GDP/CPI,
              business cycle, fiscal vs monetary policy, budgeting/investing, and trade/currency.
            </div>
          </div>

          <div class="rules-card">
            <strong>Playtime</strong>
            <div style="margin-top:6px;">
              The board has 60 tiles; with 2‚Äì4 players it typically lasts ~20 minutes.
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <div class="left">
          <label style="display:flex; gap:8px; align-items:center; cursor:pointer;">
            <input type="checkbox" id="dontShowRules" />
            Don‚Äôt show again
          </label>
        </div>
        <div class="right">
          <button class="btn-modal" id="rulesCloseBtn">Close</button>
          <button class="btn-modal primary" id="rulesStartBtn">Start Game</button>
        </div>
      </div>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  /** ========================
   * SETTINGS
   * ======================== */
  const SETTINGS = {
    totalTiles: 60,
    players: 2,          // change to 3 or 4 if needed
    finishTile: 59,
    prosperityToWin: 15,
  };

  const TILE_TYPES = [
    { type: "decision", weight: 42 },
    { type: "quiz",     weight: 16 },
    { type: "policy",   weight: 12 },
    { type: "market",   weight: 10 },
    { type: "trade",    weight: 8  },
    { type: "bonus",    weight: 7  },
    { type: "risk",     weight: 5  },
  ];

  const TILE_LABEL = {
    start:   { icon: "üèÅ", name: "Start" },
    finish:  { icon: "üèÜ", name: "Finish" },
    decision:{ icon: "‚ùì", name: "Decision" },
    quiz:    { icon: "üß†", name: "Quick Quiz" },
    policy:  { icon: "‚öñÔ∏è", name: "Policy" },
    market:  { icon: "üì¶", name: "Market" },
    trade:   { icon: "üåç", name: "Trade" },
    bonus:   { icon: "üí∞", name: "Bonus" },
    risk:    { icon: "üé≤", name: "Risk" },
  };

  function weightedPick(options) {
    const total = options.reduce((s,o)=>s+o.weight,0);
    let r = Math.random() * total;
    for (const o of options) {
      r -= o.weight;
      if (r <= 0) return o.type;
    }
    return options[0].type;
  }

  function tileTypeFor(tileIndex) {
    if (tileIndex === 0) return "start";
    if (tileIndex === SETTINGS.finishTile) return "finish";
    return weightedPick(TILE_TYPES);
  }

  // Hidden unit progression (no labels shown to players)
  function unitBucketForProgress(tileIndex) {
    const p = tileIndex / SETTINGS.totalTiles;
    if (p < 0.25) return "unit1";
    if (p < 0.50) return "unit2";
    if (p < 0.75) return "unit3";
    return "unit45";
  }

  /** ========================
   * CONTENT (balanced + course-based)
   * ======================== */
  const CARDS = {
    unit1: [
      { title:"Scarcity", prompt:"You can only fund ONE project this year (limited resources).", A:{text:"Build factories (fast output)", effects:{gdp:+2, cash:-200, ineq:+1}}, B:{text:"Invest in education (long-term)", effects:{cash:-150}, delayed:{inTurns:2, effects:{gdp:+3, unemp:-1, prosperity:+1}}} },
      { title:"Opportunity Cost", prompt:"You spend heavily on one goal. What trade-off do you accept?", A:{text:"Big infrastructure push", effects:{cash:-250}, delayed:{inTurns:1, effects:{gdp:+3}}}, B:{text:"Social programs now", effects:{cash:-250, prosperity:+1, ineq:-1}} },
      { title:"PPF Trade-Off", prompt:"On a PPF, increasing one output usually means:", A:{text:"Less of something else (trade-off)", effects:{prosperity:+1}}, B:{text:"Everything increases equally", effects:{prosperity:-1}} },
      { title:"Factors of Production", prompt:"Training workers builds which resource?", A:{text:"Labour (human capital)", effects:{unemp:-1, gdp:+1, prosperity:+1}}, B:{text:"Land", effects:{prosperity:-1}} },
    ],
    unit2: [
      { title:"Supply & Demand", prompt:"Demand rises, supply stays the same. Most likely result?", A:{text:"Price rises", effects:{inflation:+1, cash:+150, prosperity:+1}}, B:{text:"Price falls", effects:{prosperity:-1}} },
      { title:"Price Ceiling", prompt:"A price ceiling is set below equilibrium (rent).", A:{text:"Affordability improves", effects:{prosperity:+1, ineq:-1}}, B:{text:"Shortage risk later", effects:{}, delayed:{inTurns:1, effects:{gdp:-1, unemp:+1}}} },
      { title:"Minimum Wage", prompt:"Minimum wage increases. Choose the main trade-off.", A:{text:"Higher incomes boost demand", effects:{gdp:+1, ineq:-1, inflation:+1}}, B:{text:"Higher costs may reduce hiring", effects:{unemp:+1, cash:+100}} },
      { title:"Unemployment", prompt:"High unemployment usually means:", A:{text:"Idle resources + lower output", effects:{prosperity:+1}}, B:{text:"Higher GDP automatically", effects:{prosperity:-1}} },
    ],
    unit3: [
      { title:"Recession", prompt:"GDP falling + unemployment rising. Pick a response.", A:{text:"Fiscal: increase gov spending", effects:{cash:-300, gdp:+2, unemp:-1}}, B:{text:"Monetary: lower interest rates", effects:{gdp:+1, inflation:+1}, delayed:{inTurns:1, effects:{gdp:+1}}} },
      { title:"Inflation (CPI)", prompt:"CPI rises quickly. What happens to purchasing power?", A:{text:"Purchasing power decreases", effects:{prosperity:+1}}, B:{text:"Purchasing power increases", effects:{prosperity:-1}} },
      { title:"Fight Inflation", prompt:"Inflation is high. Best tool to cool demand is:", A:{text:"Raise interest rates", effects:{inflation:-2, gdp:-1, prosperity:+1}}, B:{text:"Print money", effects:{inflation:+2, prosperity:-1}} },
      { title:"Inequality (Lorenz)", prompt:"Inequality rises. Choose a policy approach.", A:{text:"Progressive taxes + transfers", effects:{cash:-150, ineq:-2, prosperity:+1}}, B:{text:"Cut taxes to attract investment", effects:{gdp:+2, ineq:+1}} },
    ],
    unit45: [
      { title:"Budgeting", prompt:"You build an emergency fund instead of spending everything.", A:{text:"Save now, safer later", effects:{cash:-100, prosperity:+1}, delayed:{inTurns:2, effects:{cash:+250}}}, B:{text:"Spend now for growth", effects:{cash:-200, gdp:+2}} },
      { title:"Investing", prompt:"Pick an investment style.", A:{text:"Diversified fund (steady)", effects:{cash:-200}, delayed:{inTurns:1, effects:{cash:+260, prosperity:+1}}}, B:{text:"High-risk stock (gamble)", effects:{cash:-200}, delayed:{inTurns:1, rng:true}} },
      { title:"Comparative Advantage", prompt:"Why do countries trade?", A:{text:"Specialize (lower opportunity cost)", effects:{gdp:+2, prosperity:+1}}, B:{text:"Trade always harms both sides", effects:{prosperity:-1}} },
      { title:"Currency Change", prompt:"Your currency weakens. Likely effect?", A:{text:"Exports cheaper ‚Üí more demand", effects:{gdp:+1, cash:+100, prosperity:+1}}, B:{text:"Imports cheaper ‚Üí inflation drops", effects:{prosperity:-1}} },
    ],
  };

  const QUIZZES = [
    { q:"Economics is the study of:", A:"Choices with scarce resources", B:"Only stock markets", correct:"A", ok:{prosperity:+1}, bad:{prosperity:-1} },
    { q:"When demand rises and supply stays the same, price usually:", A:"Rises", B:"Falls", correct:"A", ok:{cash:+100, inflation:+1}, bad:{prosperity:-1} },
    { q:"Fiscal policy is mainly about:", A:"Taxes + government spending", B:"Only interest rates", correct:"A", ok:{prosperity:+1}, bad:{prosperity:-1} },
    { q:"CPI is used to measure:", A:"Inflation", B:"Unemployment", correct:"A", ok:{prosperity:+1}, bad:{prosperity:-1} },
    { q:"Comparative advantage means:", A:"Lower opportunity cost", B:"Being best at everything", correct:"A", ok:{gdp:+1, prosperity:+1}, bad:{prosperity:-1} },
  ];

  const MARKET_SHOCKS = [
    { title:"Oil Price Shock", prompt:"Energy prices rise suddenly.", A:"Absorb the shock", effA:{inflation:+2, cash:-50}, B:"Subsidize fuel briefly", effB:{cash:-150, inflation:+1, prosperity:+1} },
    { title:"Tech Boom", prompt:"A new technology boosts productivity.", A:"Invest in it", effA:{gdp:+2, cash:-100}, B:"Ignore it for now", effB:{cash:+100, prosperity:-1} },
    { title:"Supply Disruption", prompt:"Supply falls (producer shutdown).", A:"Support producers", effA:{cash:-200, gdp:+1}, B:"Do nothing", effB:{inflation:+1, unemp:+1} },
  ];

  const BONUSES = [
    { title:"Good Budgeting", prompt:"You stuck to your budget this month.", A:"Nice!", effA:{cash:+150, prosperity:+1}, B:"Over-spend anyway", effB:{cash:-100, prosperity:-1} },
    { title:"Entrepreneurship", prompt:"A local business innovates and expands.", A:"Support it", effA:{gdp:+1, cash:-100, prosperity:+1}, B:"Do nothing", effB:{prosperity:-1} },
  ];

  /** ========================
   * STATE
   * ======================== */
  const state = {
    currentPlayer: 0,
    positions: Array.from({length: SETTINGS.players}, () => 0),
    players: Array.from({length: SETTINGS.players}, (_, i) => ({
      name: `Player ${i+1}`,
      cash: 1000,
      gdp: 10,
      unemp: 5,
      inflation: 2,
      ineq: 4,
      prosperity: 0,
      queue: [],
    })),
    awaitingChoice: false,
    gameOver: false,
  };

  function clampStats(p) {
    p.cash = Math.max(0, p.cash);
    p.gdp = Math.max(0, p.gdp);
    p.unemp = Math.min(25, Math.max(0, p.unemp));
    p.inflation = Math.min(15, Math.max(0, p.inflation));
    p.ineq = Math.min(10, Math.max(0, p.ineq));
  }

  function prosperityScore(p) {
    return Math.round(
      (p.gdp)
      - 2*(p.unemp)
      - 1.5*(p.inflation)
      - 1.5*(p.ineq)
      + (p.cash/200)
      + (p.prosperity)
    );
  }

  function applyEffects(p, effects) {
    if (!effects) return;
    for (const [k,v] of Object.entries(effects)) {
      if (k in p) p[k] += v;
    }
    clampStats(p);
  }

  /** ========================
   * UI HOOKS
   * ======================== */
  const boardEl = document.getElementById("board");
  const rollBtn = document.getElementById("rollBtn");
  const rulesBtn = document.getElementById("rulesBtn");
  const diceOut = document.getElementById("diceOut");
  const progressOut = document.getElementById("progressOut");
  const turnOut = document.getElementById("turnOut");
  const goalOut = document.getElementById("goalOut");
  const statsEl = document.getElementById("stats");
  const eventBox = document.getElementById("eventBox");
  const choicesEl = document.getElementById("choices");
  const logEl = document.getElementById("log");

  const rulesModal = document.getElementById("rulesModal");
  const rulesCloseX = document.getElementById("rulesCloseX");
  const rulesCloseBtn = document.getElementById("rulesCloseBtn");
  const rulesStartBtn = document.getElementById("rulesStartBtn");
  const dontShowRules = document.getElementById("dontShowRules");

  function logEntry({ icon="‚Ä¢", title="", detail="" }) {
    const div = document.createElement("div");
    div.className = "log-item";
    div.innerHTML = `
      <div class="log-top">
        <div class="log-ico">${icon}</div>
        <div>
          <div class="log-title">${title}</div>
          ${detail ? `<div class="log-detail">${detail}</div>` : ""}
        </div>
      </div>
    `;
    logEl.prepend(div);
  }

  // Safety: if any old code calls log("..."), it won't crash
  function log(msg){ logEntry({ icon:"‚Ä¢", title: msg }); }

  /** ========================
   * RENDER
   * ======================== */
  function renderHeader(lastDice="‚Äî") {
    diceOut.textContent = `Dice: ${lastDice}`;
    const pos = state.positions[state.currentPlayer];
    progressOut.textContent = `Progress: ${pos} / ${SETTINGS.finishTile}`;
    turnOut.textContent = `Turn: ${state.players[state.currentPlayer].name}`;
    goalOut.textContent = `Goal: Finish + Prosperity ‚â• ${SETTINGS.prosperityToWin}`;
  }

  function renderStats() {
    statsEl.innerHTML = "";
    state.players.forEach(p => {
      const box = document.createElement("div");
      box.className = "stat-card";
      box.innerHTML = `
        <div class="stat-head">
          <div class="stat-name">${p.name}</div>
          <span class="pill">Prosperity Score: ${prosperityScore(p)}</span>
        </div>
        <div class="row" style="margin-top:10px;">
          <span class="pill">Cash: $${p.cash}</span>
          <span class="pill">GDP: ${p.gdp}</span>
          <span class="pill">Unemp: ${p.unemp}%</span>
          <span class="pill">Inflation: ${p.inflation}%</span>
          <span class="pill">Inequality: ${p.ineq}/10</span>
        </div>
        <div class="small" style="margin-top:8px;">Queued effects: ${p.queue.length}</div>
      `;
      statsEl.appendChild(box);
    });
  }

  function renderBoard() {
    boardEl.innerHTML = "";
    for (let i=0; i<SETTINGS.totalTiles; i++) {
      const t = tileTypeFor(i);
      const meta = TILE_LABEL[t];

      const tile = document.createElement("div");
      tile.className = `tile ${t}`;
      if (t === "start") tile.classList.add("start");
      if (t === "finish") tile.classList.add("finish");
      if (i === state.positions[state.currentPlayer]) tile.classList.add("active");

      const tokensHere = state.positions
        .map((pos, idx) => ({pos, idx}))
        .filter(x => x.pos === i);

      const tokenRow = document.createElement("div");
      tokenRow.style.display = "flex";
      tokenRow.style.flexWrap = "wrap";
      tokensHere.forEach(tk => {
        const dot = document.createElement("span");
        dot.className = "token";
        dot.style.background = ["#ffffff","#60a5fa","#22c55e","#f87171"][tk.idx] || "#fff";
        dot.title = state.players[tk.idx].name;
        tokenRow.appendChild(dot);
      });

      tile.innerHTML = `
        <div class="idx">#${i}</div>
        <div class="name">
          <span class="icon">${meta.icon}</span>
          <span class="label">${meta.name}</span>
        </div>
      `;
      tile.appendChild(tokenRow);
      boardEl.appendChild(tile);
    }
  }

  /** ========================
   * EFFECTS + QUEUE
   * ======================== */
  function formatEffects(effects) {
    if (!effects) return "";
    return Object.entries(effects)
      .map(([k,v]) => `${k} ${v>0?"+":""}${v}`)
      .join(", ");
  }

  function runQueuedEffects(p) {
    p.queue.forEach(q => q.inTurns--);
    const ready = p.queue.filter(q => q.inTurns <= 0);
    p.queue = p.queue.filter(q => q.inTurns > 0);

    ready.forEach(q => {
      if (q.rng) {
        const win = Math.random() < 0.5;
        if (win) {
          applyEffects(p, { cash:+450, prosperity:+1 });
          logEntry({ icon:"üìà", title:`${p.name} investment paid off`, detail:"+$450, +1 prosperity" });
        } else {
          applyEffects(p, { cash:-200, prosperity:-1 });
          logEntry({ icon:"üìâ", title:`${p.name} investment failed`, detail:"-$200, -1 prosperity" });
        }
      } else {
        applyEffects(p, q.effects);
        logEntry({ icon:"‚è≥", title:`${p.name} delayed effect triggered`, detail: formatEffects(q.effects) });
      }
    });
  }

  /** ========================
   * CARD PICKERS
   * ======================== */
  const randomPick = (arr) => arr[Math.floor(Math.random()*arr.length)];

  function decisionCardFor(tileIndex) {
    const bucket = unitBucketForProgress(tileIndex);
    return randomPick(CARDS[bucket]);
  }

  function quizCard() {
    const q = randomPick(QUIZZES);
    return {
      title: "Quick Quiz",
      prompt: q.q,
      A: { text: q.A, effects: (q.correct==="A") ? q.ok : q.bad },
      B: { text: q.B, effects: (q.correct==="B") ? q.ok : q.bad },
    };
  }

  function policyCard() {
    const options = [
      { title:"Policy Choice", prompt:"Unemployment is rising. Choose a policy tool.", A:{text:"Fiscal stimulus (spending)", effects:{cash:-250, gdp:+2, unemp:-1}}, B:{text:"Cut taxes (demand boost)", effects:{cash:-150, gdp:+1, ineq:+1}} },
      { title:"Policy Choice", prompt:"Inflation is rising (CPI up). What do you do?", A:{text:"Raise interest rates", effects:{inflation:-2, gdp:-1, prosperity:+1}}, B:{text:"Do nothing (wait)", effects:{inflation:+1, prosperity:-1}} },
    ];
    return randomPick(options);
  }

  function marketCard() {
    const m = randomPick(MARKET_SHOCKS);
    return { title:m.title, prompt:m.prompt, A:{text:m.A, effects:m.effA}, B:{text:m.B, effects:m.effB} };
  }

  function bonusCard() {
    const b = randomPick(BONUSES);
    return { title:b.title, prompt:b.prompt, A:{text:b.A, effects:b.effA}, B:{text:b.B, effects:b.effB} };
  }

  function tradeCard() {
    return {
      title:"Trade Deal",
      prompt:"Trade can benefit both sides (comparative advantage). Do you accept a trade deal?",
      A:{ text:"Accept trade", effects:{gdp:+1, prosperity:+1} },
      B:{ text:"Decline trade", effects:{prosperity:-1} }
    };
  }

  function riskCard() {
    return {
      title:"Investment Risk",
      prompt:"Take a risk for a potential reward?",
      A:{ text:"Take the risk (coin flip next turn)", effects:{}, delayed:{inTurns:1, rng:true} },
      B:{ text:"Play it safe", effects:{prosperity:+1, cash:+50} }
    };
  }

  /** ========================
   * CHOICES + WIN
   * ======================== */
  function showCard(card) {
    eventBox.innerHTML = `<strong>${card.title}</strong><div class="small" style="margin-top:6px;">${card.prompt}</div>`;
    choicesEl.innerHTML = "";

    const mk = (label, which) => {
      const btn = document.createElement("button");
      btn.className = "btn2";
      btn.textContent = label;
      btn.onclick = () => choose(card, which);
      return btn;
    };

    choicesEl.appendChild(mk("A) " + card.A.text, "A"));
    choicesEl.appendChild(mk("B) " + card.B.text, "B"));

    state.awaitingChoice = true;
  }

  function checkWin(pIndex) {
    const p = state.players[pIndex];
    const atFinish = state.positions[pIndex] >= SETTINGS.finishTile;
    if (!atFinish) return false;

    const score = prosperityScore(p);
    if (score >= SETTINGS.prosperityToWin) {
      state.gameOver = true;
      rollBtn.disabled = true;
      choicesEl.innerHTML = "";
      eventBox.innerHTML = `<strong>üèÜ ${p.name} WINS!</strong><div class="small" style="margin-top:6px;">Reached Finish with Prosperity Score ${score}.</div>`;
      logEntry({ icon:"üèÜ", title:`Winner: ${p.name}`, detail:`Prosperity Score ${score} (goal ‚â• ${SETTINGS.prosperityToWin})` });
      return true;
    }

    eventBox.innerHTML = `<strong>${p.name} reached the Finish‚Ä¶</strong><div class="small" style="margin-top:6px;">But Prosperity Score (${score}) is below ${SETTINGS.prosperityToWin}. Keep playing.</div>`;
    logEntry({ icon:"‚ö†Ô∏è", title:`${p.name} reached Finish but didn‚Äôt qualify`, detail:`Prosperity Score ${score} (need ‚â• ${SETTINGS.prosperityToWin})` });
    return false;
  }

  function choose(card, which) {
    const p = state.players[state.currentPlayer];

    // Apply delayed effects first (so the game feels ‚Äúalive‚Äù)
    runQueuedEffects(p);

    const choice = card[which];
    applyEffects(p, choice.effects);

    if (choice.delayed) p.queue.push({...choice.delayed});

    logEntry({
      icon: (which === "A") ? "üÖ∞Ô∏è" : "üÖ±Ô∏è",
      title: `${p.name} chose ${which}`,
      detail: `${choice.text}${choice.effects ? " ‚Ä¢ " + formatEffects(choice.effects) : ""}${choice.delayed ? " ‚Ä¢ (delayed effect)" : ""}`
    });

    // gentle penalty if cash hits 0
    if (p.cash === 0) {
      applyEffects(p, { prosperity:-1, unemp:+1 });
      logEntry({ icon:"üí∏", title:`${p.name} hit $0 cash`, detail:"Financial stress: -1 prosperity, +1 unemployment" });
    }

    renderStats();
    choicesEl.innerHTML = "";
    state.awaitingChoice = false;
    rollBtn.disabled = true;

    if (!checkWin(state.currentPlayer)) {
      setTimeout(nextTurn, 250);
    }
  }

  function nextTurn() {
    if (state.gameOver) return;
    state.currentPlayer = (state.currentPlayer + 1) % SETTINGS.players;
    renderBoard();
    renderStats();
    renderHeader("‚Äî");
    eventBox.textContent = "Roll to continue.";
    choicesEl.innerHTML = "";
    rollBtn.disabled = false;
  }

  function cardForLanding(tileIndex) {
    const t = tileTypeFor(tileIndex);

    if (t === "start") {
      return {
        title:"Start",
        prompt:`Welcome! Win by reaching Finish AND Prosperity Score ‚â• ${SETTINGS.prosperityToWin}.`,
        A:{ text:"Start with a plan (+cash buffer)", effects:{cash:+100, prosperity:+1} },
        B:{ text:"Go aggressive early (+GDP, +inflation)", effects:{gdp:+1, inflation:+1} }
      };
    }
    if (t === "finish") {
      return {
        title:"Finish",
        prompt:"You reached the finish line. Try to qualify for the win.",
        A:{ text:"Stabilize (lower inflation)", effects:{inflation:-1, cash:-50} },
        B:{ text:"Boost growth (risk inflation)", effects:{gdp:+1, inflation:+1} }
      };
    }

    if (t === "decision") return decisionCardFor(tileIndex);
    if (t === "quiz") return quizCard();
    if (t === "policy") return policyCard();
    if (t === "market") return marketCard();
    if (t === "trade") return tradeCard();
    if (t === "bonus") return bonusCard();
    if (t === "risk") return riskCard();

    return decisionCardFor(tileIndex);
  }

  /** ========================
   * BUTTONS
   * ======================== */
  rollBtn.addEventListener("click", () => {
    if (state.gameOver || state.awaitingChoice) return;

    const roll = Math.floor(Math.random()*6)+1;
    const idx = state.currentPlayer;

    let newPos = state.positions[idx] + roll;
    if (newPos > SETTINGS.finishTile) newPos = SETTINGS.finishTile;
    state.positions[idx] = newPos;

    renderHeader(roll);
    renderBoard();

    const tileIndex = state.positions[idx];
    const p = state.players[idx];

    logEntry({ icon:"üé≤", title:`${p.name} rolled ${roll}`, detail:`Moved to tile #${tileIndex}` });

    const card = cardForLanding(tileIndex);
    showCard(card);

    rollBtn.disabled = true;
  });

  // Rules modal (always works + auto-show unless hidden)
  function openRules(){ rulesModal.style.display = "flex"; }
  function closeRules(){ rulesModal.style.display = "none"; }

  rulesBtn.addEventListener("click", openRules);
  rulesCloseX.addEventListener("click", closeRules);
  rulesCloseBtn.addEventListener("click", closeRules);
  rulesStartBtn.addEventListener("click", closeRules);

  rulesModal.addEventListener("click", (e) => {
    if (e.target === rulesModal) closeRules();
  });

  dontShowRules.addEventListener("change", () => {
    localStorage.setItem("econation_hide_rules", dontShowRules.checked ? "1" : "0");
  });

  /** ========================
   * INIT
   * ======================== */
  renderBoard();
  renderStats();
  renderHeader("‚Äî");
  logEntry({ icon:"‚úÖ", title:"Game ready", detail:"Click Roll Dice to begin." });

  // Auto-open rules unless hidden
  const hide = localStorage.getItem("econation_hide_rules") === "1";
  if (!hide) openRules();
});
</script>
</body>
</html>
