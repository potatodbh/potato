<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EconNation ‚Äî Race to Prosperity</title>

  <style>
    :root{
      --bg:#0b0d10;
      --panel: rgba(255,255,255,.04);
      --panel2: rgba(255,255,255,.03);
      --border: rgba(255,255,255,.10);
      --border2: rgba(255,255,255,.14);
      --text:#e9eef5;
      --muted: rgba(255,255,255,.78);
      --muted2: rgba(255,255,255,.60);
      --shadow: 0 14px 30px rgba(0,0,0,.35);
      --r: 18px;
      font-family: system-ui, Arial, sans-serif;
      color: var(--text);
      background: var(--bg);
    }

    body{ margin:0; padding:16px; }
    h1{ margin:0 0 6px; font-size:40px; letter-spacing:.2px; }
    .sub{ opacity:.82; font-size:14px; margin-bottom:14px; }

    /* Top controls */
    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }
    .topbar-left{ min-width: 280px; }
    .topbar-right{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid var(--border2);
      background: rgba(255,255,255,.05);
      color: rgba(255,255,255,.92);
      white-space: nowrap;
    }

    button{
      border:0;
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight:700;
    }
    .btn{
      background:#fff; color:#111;
      box-shadow: 0 8px 18px rgba(0,0,0,.35);
    }
    .btn2{
      background: rgba(255,255,255,.06);
      color:#fff;
      border: 1px solid rgba(255,255,255,.14);
    }
    button:disabled{ opacity:.5; cursor:not-allowed; }

    select{
      background: rgba(255,255,255,.06);
      color:#fff;
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 12px;
      padding: 8px 10px;
      font-weight:700;
      outline:none;
    }

    /* Main layout */
    .wrap{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 1100px){
      .wrap{ grid-template-columns: 1fr; }
    }

    /* Make layout feel ‚Äúdashboard-y‚Äù */
.wrap{
  display:grid;
  grid-template-columns: 1.45fr 0.55fr;
  gap: 14px;
  align-items: start;
}

/* Sidebar card */
.card.right{
  position: sticky;
  top: 12px;
  align-self: start;
}

/* Small controls row at top of sidebar */
.rightTop{ margin-bottom: 6px; }

.controlRow{
  display:flex;
  gap: 10px;
  flex-wrap: wrap;
  align-items: center;
  justify-content: flex-end; /* pushes them to the right */
}

.miniLabel{
  opacity:.8;
  font-size: 12px;
  margin-right: -4px;
}

.select{
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.14);
  color: #fff;
  border-radius: 12px;
  padding: 8px 10px;
  outline: none;
}

/* Big roll button section */
.ctaWrap{
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid rgba(255,255,255,.10);
  display:grid;
  gap: 8px;
}

.btn.cta{
  width: 100%;
  font-size: 16px;
  font-weight: 900;
  padding: 14px 14px;
  border-radius: 16px;
  letter-spacing: .2px;
  box-shadow: 0 14px 34px rgba(0,0,0,.45);
}

.ctaHint{
  font-size: 12px;
  opacity: .82;
  text-align: center;
}

/* Mobile: stack sidebar under board */
@media (max-width: 1100px){
  .wrap{ grid-template-columns: 1fr; }
  .card.right{ position: static; }
  .controlRow{ justify-content: flex-start; }
}
    .card{
      background: var(--panel);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--r);
      padding: 14px;
      box-shadow: var(--shadow);
    }

    .card h2{ margin:0 0 10px; }

    /* Board */
    .board{
      display:grid;
      grid-template-columns: repeat(10, minmax(96px, 1fr));
      gap:10px;
      user-select:none;
      align-items:stretch;
    }
    @media (max-width: 1100px){
      .board{ grid-template-columns: repeat(8, minmax(96px, 1fr)); }
    }
    @media (max-width: 650px){
      .board{ grid-template-columns: repeat(6, minmax(96px, 1fr)); }
    }

    .tile{
      min-height: 84px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      overflow: visible; /* IMPORTANT: no clipping/ellipsis */
    }
    .tile .idx{ opacity:.62; font-size:11px; }
    .tile .name{
      font-weight: 800;
      font-size: 13px;
      line-height: 1.15;
      letter-spacing:.2px;
      white-space: normal;      /* allow wrap */
      overflow: visible;        /* no ellipsis */
      text-overflow: unset;     /* no ellipsis */
      word-break: normal;       /* don't break Decision */
      overflow-wrap: anywhere;  /* safety on tiny screens */
    }

    .tokenRow{ display:flex; flex-wrap:wrap; gap:6px; padding-top:6px; }
    .token{
      width: 10px; height:10px;
      border-radius: 50%;
      border: 1px solid rgba(255,255,255,.25);
    }

    /* Tile accents */
    .tile.decision { border-color: rgba(244, 63, 94, .35); box-shadow: 0 0 0 1px rgba(244,63,94,.08) inset; }
    .tile.quiz     { border-color: rgba(168, 85, 247, .35); box-shadow: 0 0 0 1px rgba(168,85,247,.08) inset; }
    .tile.policy   { border-color: rgba(250, 204, 21, .35); box-shadow: 0 0 0 1px rgba(250,204,21,.08) inset; }
    .tile.market   { border-color: rgba(34, 197, 94, .35); box-shadow: 0 0 0 1px rgba(34,197,94,.08) inset; }
    .tile.trade    { border-color: rgba(59, 130, 246, .35); box-shadow: 0 0 0 1px rgba(59,130,246,.08) inset; }
    .tile.bonus    { border-color: rgba(249, 115, 22, .35); box-shadow: 0 0 0 1px rgba(249,115,22,.08) inset; }
    .tile.risk     { border-color: rgba(255, 255, 255, .20); box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset; }

    .tile.active{
      outline: 2px solid rgba(255,255,255,.65);
      box-shadow: 0 0 0 5px rgba(255,255,255,.06), 0 18px 28px rgba(0,0,0,.30);
    }
    .tile.start{
      background: linear-gradient(135deg, rgba(96,165,250,.18), rgba(255,255,255,.04));
      border-color: rgba(96,165,250,.35);
    }
    .tile.finish{
      background: linear-gradient(135deg, rgba(255,215,0,.18), rgba(255,255,255,.04));
      border-color: rgba(255,215,0,.35);
    }

    .small{ font-size:12px; opacity:.82; }
    .muted{ opacity:.75; }

    /* Right panel: Info + Log only */
    .infoBlock{
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 10px;
    }
    .infoBlock h3{ margin:0 0 8px; font-size:14px; }
    .log{
      max-height: 430px;
      overflow:auto;
      font-size: 12px;
      line-height: 1.35;
      background: rgba(255,255,255,.02);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .logRow{
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .logIcon{ width:22px; opacity:.95; flex: 0 0 auto; }
    .logTitle{ font-weight:800; letter-spacing:.1px; }
    .logDetail{ opacity:.82; margin-top:2px; }

    /* Bottom player strip */
    .playersStrip{
      margin-top: 12px;
      display:flex;
      gap:10px;
      overflow:auto;
      padding-bottom: 4px;
    }
    .playerCard{
      min-width: 260px;
      flex: 0 0 auto;
      background: var(--panel2);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 12px;
    }
    .playerTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .playerName{
      font-weight: 900;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .dot{
      width: 10px; height:10px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,.25);
    }
    .statGrid{
      display:flex; flex-wrap:wrap; gap:8px;
    }
    .statPill{
      display:inline-flex;
      align-items:center;
      padding: 6px 9px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      white-space: nowrap;
    }

    /* ---------- Rules Modal ---------- */
    .modal-backdrop{
      position: fixed; inset: 0;
      background: rgba(0,0,0,.70);
      backdrop-filter: blur(6px);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index: 9999;
      padding: 16px;
    }
    .modal{
      width: min(920px, 96vw);
      max-height: 86vh;
      overflow:auto;
      background: #0b0d10;                 /* opaque */
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 18px;
      box-shadow: 0 20px 70px rgba(0,0,0,.65);
    }
    .modal-header{
      position: sticky; top:0;
      background: #0b0d10;                 /* opaque */
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .modal-title{ font-size:18px; font-weight:900; }
    .modal-x{
      appearance:none; border:0; background:transparent;
      color:#fff; font-size:22px; cursor:pointer; opacity:.85;
    }
    .modal-x:hover{ opacity:1; }
    .modal-body{ padding: 14px 16px 16px; line-height: 1.35; font-size: 14px; color: rgba(255,255,255,.92); }
    .rules-grid{ display:grid; gap:10px; grid-template-columns: 1fr 1fr; }
    @media (max-width: 800px){ .rules-grid{ grid-template-columns: 1fr; } }
    .rules-card{
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .modal-footer{
      padding: 12px 16px 16px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      border-top: 1px solid rgba(255,255,255,.10);
    }
    .btn-modal{
      border-radius: 12px;
      padding: 10px 12px;
      cursor:pointer;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:#fff;
      font-weight:900;
    }
    .btn-modal.primary{ background:#fff; color:#111; border-color: transparent; }

    /* ---------- Turn Card Modal (centered question) ---------- */
    .turn-backdrop{
      position: fixed; inset:0;
      background: rgba(0,0,0,.78);
      backdrop-filter: blur(8px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 10000;
      padding: 16px;
    }
    .turnModal{
      width: min(980px, 96vw);
      background: #0b0d10;                 /* opaque */
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 18px;
      box-shadow: 0 22px 80px rgba(0,0,0,.72);
      overflow:hidden;
    }
    .turnHeader{
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .turnHeader h3{ margin:0; font-size:18px; font-weight:900; }
    .turnTag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      white-space: nowrap;
    }
    .turnBody{
      padding: 16px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 900px){
      .turnBody{ grid-template-columns: 1fr; }
    }
    .turnPrompt{
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 14px;
    }
    .turnMetaLine{ display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px; }
    .turnTitle{ font-size: 26px; font-weight: 950; margin: 6px 0 8px; }
    .turnText{ font-size: 16px; opacity:.92; }

    .turnChoices{
      display:grid;
      gap:10px;
    }
    .choiceBtn{
      text-align:left;
      border-radius: 16px;
      padding: 12px 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: #fff;
      cursor:pointer;
    }
    .choiceBtn:hover{ background: rgba(255,255,255,.09); }
    .choiceBtn strong{ display:block; font-size:14px; }
    .choiceBtn .fx{ display:block; margin-top:6px; font-size:12px; opacity:.78; }

    .turnFooter{
      padding: 12px 16px 16px;
      border-top: 1px solid rgba(255,255,255,.10);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      color: rgba(255,255,255,.80);
      font-size: 13px;
    }

    /* Prevent favicon 404 noise (optional) */
    link[rel="icon"] { }
  </style>

  <!-- Optional: stop favicon.ico 404 by embedding a tiny blank icon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'/>">
</head>

<body>
  <div class="topbar">
    <div class="topbar-left">
      <h1>EconNation</h1>
      <div class="sub">Race to the finish by making smart economic choices. Designed for ~20 minutes of play.</div>
    </div>

<!-- RIGHT SIDEBAR -->
<div class="card right">
  <div class="rightTop">
    <div class="controlRow">
      <label class="miniLabel">Players</label>
      <select id="playerSelect" class="select">
        <option>2</option><option>3</option><option>4</option>
      </select>

      <button id="newGameBtn" class="btn2">New Game</button>
      <button id="rulesBtn" class="btn2">Rules</button>
    </div>
  </div>

  <h2 style="margin:8px 0 10px;">Game Info</h2>

  <!-- whatever you already show here -->
  <div id="infoBox" class="infoBox">...</div>

  <h3 style="margin:12px 0 8px;">Game Log</h3>
  <div id="log" class="log"></div>

  <!-- BIG CTA BUTTON -->
  <div class="ctaWrap">
    <button id="rollBtn" class="btn cta">üé≤ Roll Dice</button>
    <div class="ctaHint" id="ctaHint">Your turn: Player 1</div>
  </div>
</div>


  <div class="wrap">
    <!-- LEFT: Board + bottom player strip -->
    <div class="card">
      <h2>Board</h2>

      <div class="muted small" style="margin:-2px 0 10px;">
        Tip: High GDP is good, but watch unemployment + inflation + inequality. Cash helps you survive shocks.
      </div>

      <div id="board" class="board"></div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:12px;">
        <span class="pill" id="diceOut">Dice: ‚Äî</span>
        <span class="pill" id="progressOut">Progress: 0 / 59</span>
        <span class="pill" id="turnOut">Turn: Player 1</span>
        <span class="pill" id="goalOut">Goal: Finish + Prosperity ‚â• 15</span>
      </div>

      <!-- Bottom player strip -->
      <div class="playersStrip" id="playersStrip" aria-label="Player stats strip"></div>
    </div>

    <!-- RIGHT: Info + log (no huge player sidebar) -->
    <div class="card">
      <h2>Game Info</h2>

      <div class="infoBlock">
        <h3>What the stats mean</h3>
        <div class="small">
          <strong>GDP</strong> = total output (growth).<br>
          <strong>Unemp</strong> = joblessness (higher is bad).<br>
          <strong>Inflation</strong> = CPI change (too high hurts).<br>
          <strong>Inequality</strong> = Lorenz gap (0‚Äì10 scale).<br><br>
          <strong>Prosperity Score</strong> rewards growth + stability.
        </div>
      </div>

      <div class="infoBlock">
        <h3>Win Condition</h3>
        <div class="small">
          To win, you must reach <strong>Finish</strong> and have <strong>Prosperity Score ‚â• 15</strong>.
        </div>
      </div>

      <div class="infoBlock">
        <h3>Last Action</h3>
        <div class="small" id="lastAction">Click <strong>Roll Dice</strong> to begin.</div>
      </div>

      <h3 style="margin:10px 0 8px;">Game Log</h3>
      <div class="log" id="log"></div>
    </div>
  </div>

  <!-- Rules Modal -->
  <div id="rulesModal" class="modal-backdrop" style="display:none;">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="rulesTitle">
      <div class="modal-header">
        <div class="modal-title" id="rulesTitle">How to Play ‚Äî EconNation</div>
        <button class="modal-x" id="rulesCloseX" aria-label="Close rules">√ó</button>
      </div>

      <div class="modal-body">
        <div class="rules-grid">
          <div class="rules-card">
            <strong>Goal</strong>
            <div style="margin-top:6px;">
              Race to the <strong>Finish</strong> tile. To win, you must reach the finish and have
              <strong>Prosperity Score ‚â• 15</strong>.
            </div>
          </div>

          <div class="rules-card">
            <strong>Your Turn</strong>
            <ol style="margin:6px 0 0 18px;">
              <li>Click <strong>Roll Dice</strong></li>
              <li>Move to a tile</li>
              <li>Answer the prompt (A/B) or quick quiz</li>
              <li>Stats update immediately (and sometimes later)</li>
            </ol>
          </div>

          <div class="rules-card">
            <strong>Tile Types</strong>
            <div style="margin-top:6px;">
              ‚ùì Decision ‚Ä¢ üß† Quick Quiz ‚Ä¢ ‚öñÔ∏è Policy ‚Ä¢ üì¶ Market ‚Ä¢ üåç Trade ‚Ä¢ üí∞ Bonus ‚Ä¢ üé≤ Risk ‚Ä¢ üèÅ Start ‚Ä¢ üèÜ Finish
            </div>
          </div>

          <div class="rules-card">
            <strong>Course connection (CIE3M)</strong>
            <div style="margin-top:6px;">
              Scarcity/opportunity cost, supply &amp; demand, price controls, GDP/CPI, business cycle,
              fiscal vs monetary policy, budgeting/investing, and trade/currency.
            </div>
          </div>

          <div class="rules-card">
            <strong>Playtime</strong>
            <div style="margin-top:6px;">
              60 tiles + choices = typically ~20 minutes for 2‚Äì4 players.
            </div>
          </div>

          <div class="rules-card">
            <strong>Tip</strong>
            <div style="margin-top:6px;">
              Don‚Äôt just chase GDP. Too much inflation/unemployment/inequality can wreck Prosperity.
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <div style="display:flex; gap:10px; align-items:center; color:rgba(255,255,255,.85); font-size:13px;">
          <label style="display:flex; gap:8px; align-items:center; cursor:pointer;">
            <input type="checkbox" id="dontShowRules" />
            Don‚Äôt show again
          </label>
        </div>
        <div style="display:flex; gap:10px;">
          <button class="btn-modal" id="rulesCloseBtn">Close</button>
          <button class="btn-modal primary" id="rulesStartBtn">Start Game</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Turn Card Modal (Center popup question) -->
  <div id="turnBackdrop" class="turn-backdrop">
    <div class="turnModal" role="dialog" aria-modal="true" aria-labelledby="turnTitle">
      <div class="turnHeader">
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <h3 id="turnTitle" style="margin:0;">Turn Card</h3>
          <span class="turnTag" id="turnWhoTag">Player ‚Äî ‚Ä¢ Tile ‚Äî</span>
          <span class="turnTag" id="turnTypeTag">Type</span>
        </div>
        <button class="modal-x" id="turnCloseX" aria-label="Close turn card">√ó</button>
      </div>

      <div class="turnBody">
        <div class="turnPrompt">
          <div class="turnMetaLine">
            <span class="turnTag" id="turnMini1">‚Äî</span>
            <span class="turnTag" id="turnMini2">‚Äî</span>
          </div>
          <div class="turnTitle" id="turnCardTitle">‚Äî</div>
          <div class="turnText" id="turnCardPrompt">‚Äî</div>
        </div>

        <div class="turnChoices" id="turnChoices"></div>
      </div>

      <div class="turnFooter">
        <div id="turnFooterHint">Pick A or B to continue.</div>
        <button class="btn2" id="turnCancelBtn">Cancel</button>
      </div>
    </div>
  </div>

<script>
/* =========================================================
   EconNation ‚Äî stable board + bottom player strip + opaque modal
   ========================================================= */

const TILE_LABEL = {
  start:   { icon: "üèÅ", name: "Start" },
  finish:  { icon: "üèÜ", name: "Finish" },
  decision:{ icon: "‚ùì", name: "Decision" },
  quiz:    { icon: "üß†", name: "Quick Quiz" },
  policy:  { icon: "‚öñÔ∏è", name: "Policy" },
  market:  { icon: "üì¶", name: "Market" },
  trade:   { icon: "üåç", name: "Trade" },
  bonus:   { icon: "üí∞", name: "Bonus" },
  risk:    { icon: "üé≤", name: "Risk" },
};

const TILE_TYPES = [
  { type: "decision", weight: 42 },
  { type: "quiz",     weight: 16 },
  { type: "policy",   weight: 12 },
  { type: "market",   weight: 10 },
  { type: "trade",    weight: 8  },
  { type: "bonus",    weight: 7  },
  { type: "risk",     weight: 5  },
];

function weightedPick(options) {
  const total = options.reduce((s,o)=>s+o.weight,0);
  let r = Math.random() * total;
  for (const o of options) {
    r -= o.weight;
    if (r <= 0) return o.type;
  }
  return options[0].type;
}

function unitBucketForProgress(tileIndex, totalTiles) {
  const p = tileIndex / totalTiles;
  if (p < 0.25) return "unit1";
  if (p < 0.50) return "unit2";
  if (p < 0.75) return "unit3";
  return "unit45";
}

/* =========================
   CONTENT (same style as your earlier version)
   ========================= */
const CARDS = {
  unit1: [
    {
      title: "Scarcity",
      prompt: "You can only fund ONE project this year (limited resources).",
      A: { text: "Build factories (fast output)", effects: { gdp:+2, cash:-200, ineq:+1 } },
      B: { text: "Invest in education (long-term)", effects: { cash:-150 }, delayed: { inTurns:2, effects:{ gdp:+3, unemp:-1, prosperity:+1 } } }
    },
    {
      title: "Opportunity Cost",
      prompt: "You spend heavily on one goal. What trade-off do you accept?",
      A: { text: "Big infrastructure push", effects: { cash:-250 }, delayed: { inTurns:1, effects:{ gdp:+3 } } },
      B: { text: "Social programs now", effects: { cash:-250, prosperity:+1, ineq:-1 } }
    },
    {
      title: "Factors of Production",
      prompt: "You train workers and improve skills. This strengthens:",
      A: { text: "Labour (human capital)", effects: { unemp:-1, gdp:+1, prosperity:+1 } },
      B: { text: "Land", effects: { prosperity:-1 } }
    },
    {
      title: "PPF Trade-Off",
      prompt: "On a PPF, increasing one output usually means:",
      A: { text: "Less of something else (trade-off)", effects: { prosperity:+1 } },
      B: { text: "Everything increases equally", effects: { prosperity:-1 } }
    },
  ],
  unit2: [
    {
      title: "Supply & Demand",
      prompt: "Demand rises, supply stays the same. Most likely result?",
      A: { text: "Price rises", effects: { inflation:+1, cash:+150, prosperity:+1 } },
      B: { text: "Price falls", effects: { prosperity:-1 } }
    },
    {
      title: "Price Ceiling",
      prompt: "A price ceiling is set below equilibrium on rent.",
      A: { text: "Affordability improves", effects: { prosperity:+1, ineq:-1 } },
      B: { text: "Shortage risk later", effects: {}, delayed: { inTurns:1, effects:{ gdp:-1, unemp:+1 } } }
    },
    {
      title: "Price Floor",
      prompt: "A price floor is set above equilibrium in agriculture.",
      A: { text: "Surplus appears", effects: { cash:-100, prosperity:+1 } },
      B: { text: "No change in market", effects: { prosperity:-1 } }
    },
    {
      title: "Minimum Wage",
      prompt: "Minimum wage increases. Choose what you prioritize.",
      A: { text: "Worker income + demand", effects: { gdp:+1, ineq:-1, inflation:+1 } },
      B: { text: "Higher business costs", effects: { unemp:+1, cash:+100 } }
    },
    {
      title: "Unemployment",
      prompt: "High unemployment usually means:",
      A: { text: "Idle resources, lower output", effects: { prosperity:+1 } },
      B: { text: "Higher GDP automatically", effects: { prosperity:-1 } }
    },
  ],
  unit3: [
    {
      title: "Recession",
      prompt: "GDP falling + unemployment rising = recession. Pick a response.",
      A: { text: "Fiscal: increase government spending", effects: { cash:-300, gdp:+2, unemp:-1 } },
      B: { text: "Monetary: lower interest rates", effects: { gdp:+1, inflation:+1 }, delayed: { inTurns:1, effects:{ gdp:+1 } } }
    },
    {
      title: "Inflation (CPI)",
      prompt: "CPI rises quickly. What happens to purchasing power?",
      A: { text: "Purchasing power decreases", effects: { prosperity:+1 } },
      B: { text: "Purchasing power increases", effects: { prosperity:-1 } }
    },
    {
      title: "Fight Inflation",
      prompt: "Inflation is high. Best tool to cool demand is:",
      A: { text: "Raise interest rates", effects: { inflation:-2, gdp:-1, prosperity:+1 } },
      B: { text: "Print money", effects: { inflation:+2, prosperity:-1 } }
    },
    {
      title: "GDP Limits",
      prompt: "True statement about GDP:",
      A: { text: "GDP doesn‚Äôt measure happiness or equality", effects: { prosperity:+1 } },
      B: { text: "GDP measures quality of life perfectly", effects: { prosperity:-1 } }
    },
    {
      title: "Inequality",
      prompt: "Inequality rises (Lorenz curve farther from equality).",
      A: { text: "Progressive taxes + transfers", effects: { cash:-150, ineq:-2, prosperity:+1 } },
      B: { text: "Cut taxes to attract investment", effects: { gdp:+2, ineq:+1 } }
    },
  ],
  unit45: [
    {
      title: "Budgeting",
      prompt: "You build an emergency fund instead of spending everything.",
      A: { text: "Save now, safer later", effects: { cash:-100, prosperity:+1 }, delayed: { inTurns:2, effects:{ cash:+250 } } },
      B: { text: "Spend now for growth", effects: { cash:-200, gdp:+2 } }
    },
    {
      title: "Investing",
      prompt: "Pick an investment style.",
      A: { text: "Diversified fund (steady)", effects: { cash:-200 }, delayed: { inTurns:1, effects:{ cash:+260, prosperity:+1 } } },
      B: { text: "High-risk stock (gamble)", effects: { cash:-200 }, delayed: { inTurns:1, rng:true } }
    },
    {
      title: "Comparative Advantage",
      prompt: "Why do countries trade?",
      A: { text: "Specialize to increase total output", effects: { gdp:+2, prosperity:+1 } },
      B: { text: "Trade always harms both sides", effects: { prosperity:-1 } }
    },
    {
      title: "Currency Change",
      prompt: "Your currency weakens. Likely effect?",
      A: { text: "Exports cheaper ‚Üí more demand", effects: { gdp:+1, cash:+100, prosperity:+1 } },
      B: { text: "Imports cheaper ‚Üí inflation drops", effects: { prosperity:-1 } }
    },
    {
      title: "Big Purchase",
      prompt: "Best move before buying a car/house is:",
      A: { text: "Budget + compare total costs (interest)", effects: { prosperity:+1 } },
      B: { text: "Buy immediately without planning", effects: { cash:-150, prosperity:-1 } }
    },
  ],
};

const QUIZZES = [
  { q: "Economics is the study of:", A:"Choices with scarce resources", B:"Only stock markets", correct:"A", ok:{prosperity:+1}, bad:{prosperity:-1} },
  { q: "When demand rises and supply stays the same, price usually:", A:"Rises", B:"Falls", correct:"A", ok:{cash:+100, inflation:+1}, bad:{prosperity:-1} },
  { q: "Fiscal policy is mainly about:", A:"Taxes + government spending", B:"Stocks only", correct:"A", ok:{prosperity:+1}, bad:{prosperity:-1} },
  { q: "CPI is used to measure:", A:"Inflation", B:"Unemployment", correct:"A", ok:{prosperity:+1}, bad:{prosperity:-1} },
  { q: "Comparative advantage means:", A:"Lower opportunity cost", B:"Being best at everything", correct:"A", ok:{gdp:+1, prosperity:+1}, bad:{prosperity:-1} },
];

const MARKET_SHOCKS = [
  { title:"Oil Price Shock", prompt:"Energy prices rise suddenly.", A:"Absorb the shock", effA:{inflation:+2, cash:-50}, B:"Subsidize fuel briefly", effB:{cash:-150, inflation:+1, prosperity:+1} },
  { title:"Tech Boom", prompt:"A new technology boosts productivity.", A:"Invest in it", effA:{gdp:+2, cash:-100}, B:"Ignore it for now", effB:{cash:+100, prosperity:-1} },
  { title:"Supply Disruption", prompt:"A supplier shuts down. Supply falls.", A:"Subsidize producers", effA:{cash:-200, gdp:+1}, B:"Do nothing (market adjusts)", effB:{inflation:+1, unemp:+1} },
];

const BONUSES = [
  { title:"Good Budgeting", prompt:"You stuck to your budget this month.", A:"Nice!", effA:{cash:+150, prosperity:+1}, B:"Over-spend anyway", effB:{cash:-100, prosperity:-1} },
  { title:"Entrepreneurship", prompt:"A local business innovates and expands.", A:"Support it", effA:{gdp:+1, cash:-100, prosperity:+1}, B:"Do nothing", effB:{prosperity:-1} },
];

/* =========================
   DOM
   ========================= */
const boardEl = document.getElementById("board");
const playersStripEl = document.getElementById("playersStrip");

const rollBtn = document.getElementById("rollBtn");
const rulesBtn = document.getElementById("rulesBtn");
const newBtn = document.getElementById("newBtn");
const playersSelect = document.getElementById("playersSelect");

const diceOut = document.getElementById("diceOut");
const progressOut = document.getElementById("progressOut");
const turnOut = document.getElementById("turnOut");
const goalOut = document.getElementById("goalOut");

const logEl = document.getElementById("log");
const lastActionEl = document.getElementById("lastAction");

/* Rules modal */
const rulesModal = document.getElementById("rulesModal");
const rulesCloseX = document.getElementById("rulesCloseX");
const rulesCloseBtn = document.getElementById("rulesCloseBtn");
const rulesStartBtn = document.getElementById("rulesStartBtn");
const dontShowRules = document.getElementById("dontShowRules");

/* Turn modal */
const turnBackdrop = document.getElementById("turnBackdrop");
const turnCloseX = document.getElementById("turnCloseX");
const turnCancelBtn = document.getElementById("turnCancelBtn");

const turnWhoTag = document.getElementById("turnWhoTag");
const turnTypeTag = document.getElementById("turnTypeTag");
const turnMini1 = document.getElementById("turnMini1");
const turnMini2 = document.getElementById("turnMini2");

const turnCardTitle = document.getElementById("turnCardTitle");
const turnCardPrompt = document.getElementById("turnCardPrompt");
const turnChoices = document.getElementById("turnChoices");
const turnFooterHint = document.getElementById("turnFooterHint");

/* =========================
   GAME STATE
   ========================= */
const SETTINGS = {
  totalTiles: 60,
  finishTile: 59,
  prosperityToWin: 15,
};

const COLORS = ["#ffffff","#60a5fa","#22c55e","#f87171"];

let state = null;

function makeFreshState(playerCount){
  const players = Array.from({length: playerCount}, (_, i) => ({
    name: `Player ${i+1}`,
    cash: 1000,
    gdp: 10,
    unemp: 5,
    inflation: 2,
    ineq: 4,
    prosperity: 0,
    queue: [],
  }));

  return {
    playerCount,
    currentPlayer: 0,
    positions: Array.from({length: playerCount}, () => 0),
    players,
    awaitingChoice: false,
    gameOver: false,
    boardTypes: generateBoardTypes(SETTINGS.totalTiles),
  };
}

function generateBoardTypes(totalTiles){
  // stable board: generated ONCE per game
  const arr = [];
  for(let i=0;i<totalTiles;i++){
    if(i===0) arr.push("start");
    else if(i===SETTINGS.finishTile) arr.push("finish");
    else arr.push(weightedPick(TILE_TYPES));
  }
  return arr;
}

function clampStats(p) {
  p.cash = Math.max(0, p.cash);
  p.gdp = Math.max(0, p.gdp);
  p.unemp = Math.min(25, Math.max(0, p.unemp));
  p.inflation = Math.min(15, Math.max(0, p.inflation));
  p.ineq = Math.min(10, Math.max(0, p.ineq));
}

function prosperityScore(p) {
  return Math.round(
    (p.gdp)
    - 2*(p.unemp)
    - 1.5*(p.inflation)
    - 1.5*(p.ineq)
    + (p.cash/200)
    + (p.prosperity)
  );
}

function applyEffects(p, effects) {
  if (!effects) return;
  for (const [k,v] of Object.entries(effects)) {
    if (k in p) p[k] += v;
  }
  clampStats(p);
}

function randomPick(arr) { return arr[Math.floor(Math.random()*arr.length)]; }

function formatEffects(effects) {
  if (!effects) return "";
  const nice = (k) => ({
    cash:"Cash",
    gdp:"GDP",
    unemp:"Unemp",
    inflation:"Inflation",
    ineq:"Inequality",
    prosperity:"Prosperity"
  }[k] || k);

  return Object.entries(effects)
    .map(([k,v]) => `${nice(k)} ${v>0?"+":""}${v}`)
    .join(", ");
}

/* =========================
   LOG + LAST ACTION
   ========================= */
function logEntry({ icon="‚Ä¢", title="", detail="" }){
  const row = document.createElement("div");
  row.className = "logRow";
  row.innerHTML = `
    <div class="logIcon">${icon}</div>
    <div>
      <div class="logTitle">${title}</div>
      ${detail ? `<div class="logDetail">${detail}</div>` : ""}
    </div>
  `;
  logEl.prepend(row);
}

function setLastAction(text){
  lastActionEl.innerHTML = text;
}

/* =========================
   RENDER
   ========================= */
function renderHeader(lastDice="‚Äî"){
  diceOut.textContent = `Dice: ${lastDice}`;
  const pos = state.positions[state.currentPlayer];
  progressOut.textContent = `Progress: ${pos} / ${SETTINGS.finishTile}`;
  turnOut.textContent = `Turn: ${state.players[state.currentPlayer].name}`;
  goalOut.textContent = `Goal: Finish + Prosperity ‚â• ${SETTINGS.prosperityToWin}`;
}

function renderBoard(){
  boardEl.innerHTML = "";
  for(let i=0;i<SETTINGS.totalTiles;i++){
    const t = state.boardTypes[i];
    const meta = TILE_LABEL[t];

    const tile = document.createElement("div");
    tile.className = `tile ${t}`;
    if(t==="start") tile.classList.add("start");
    if(t==="finish") tile.classList.add("finish");
    if(i === state.positions[state.currentPlayer]) tile.classList.add("active");

    const tokenRow = document.createElement("div");
    tokenRow.className = "tokenRow";

    state.positions.forEach((pos, idx)=>{
      if(pos===i){
        const dot = document.createElement("span");
        dot.className = "token";
        dot.style.background = COLORS[idx] || "#fff";
        dot.title = state.players[idx].name;
        tokenRow.appendChild(dot);
      }
    });

    tile.innerHTML = `
      <div class="idx">#${i}</div>
      <div class="name"><span style="margin-right:6px;">${meta.icon}</span>${meta.name}</div>
    `;
    tile.appendChild(tokenRow);
    boardEl.appendChild(tile);
  }
}

function renderPlayersStrip(){
  playersStripEl.innerHTML = "";
  state.players.forEach((p, idx)=>{
    const card = document.createElement("div");
    card.className = "playerCard";

    const score = prosperityScore(p);

    card.innerHTML = `
      <div class="playerTop">
        <div class="playerName">
          <span class="dot" style="background:${COLORS[idx] || "#fff"};"></span>
          ${p.name}
        </div>
        <span class="pill">Prosperity: ${score}</span>
      </div>

      <div class="statGrid">
        <span class="statPill">Cash: $${p.cash}</span>
        <span class="statPill">GDP: ${p.gdp}</span>
        <span class="statPill">Unemp: ${p.unemp}%</span>
        <span class="statPill">Inflation: ${p.inflation}%</span>
        <span class="statPill">Inequality: ${p.ineq}/10</span>
        <span class="statPill">Queued: ${p.queue.length}</span>
      </div>
    `;
    playersStripEl.appendChild(card);
  });
}

/* =========================
   QUEUED EFFECTS
   ========================= */
function runQueuedEffects(p){
  p.queue.forEach(q => q.inTurns--);
  const ready = p.queue.filter(q => q.inTurns <= 0);
  p.queue = p.queue.filter(q => q.inTurns > 0);

  ready.forEach(q => {
    if(q.rng){
      const win = Math.random() < 0.5;
      if(win){
        applyEffects(p, { cash:+450, prosperity:+1 });
        logEntry({ icon:"üìà", title:`${p.name} investment paid off`, detail:"+$450, +1 Prosperity" });
      } else {
        applyEffects(p, { cash:-200, prosperity:-1 });
        logEntry({ icon:"üìâ", title:`${p.name} investment failed`, detail:"-$200, -1 Prosperity" });
      }
    } else {
      applyEffects(p, q.effects);
      logEntry({ icon:"‚è≥", title:`${p.name} delayed effect triggered`, detail: formatEffects(q.effects) });
    }
  });
}

/* =========================
   CARD FACTORIES
   ========================= */
function decisionCardFor(tileIndex){
  const bucket = unitBucketForProgress(tileIndex, SETTINGS.totalTiles);
  return randomPick(CARDS[bucket]);
}

function quizCard(){
  const q = randomPick(QUIZZES);
  return {
    title: "Quick Quiz",
    prompt: q.q,
    A: { text: q.A, effects: q.correct === "A" ? q.ok : q.bad },
    B: { text: q.B, effects: q.correct === "B" ? q.ok : q.bad },
    type: "quiz"
  };
}

function policyCard(){
  const options = [
    {
      title: "Policy Choice",
      prompt: "Unemployment is rising. Pick a policy tool.",
      A: { text: "Fiscal stimulus (spending)", effects: { cash:-250, gdp:+2, unemp:-1 } },
      B: { text: "Cut taxes (demand boost)", effects: { cash:-150, gdp:+1, ineq:+1 } }
    },
    {
      title: "Policy Choice",
      prompt: "Inflation is rising (CPI up). What do you do?",
      A: { text: "Raise interest rates", effects: { inflation:-2, gdp:-1, prosperity:+1 } },
      B: { text: "Do nothing for now", effects: { inflation:+1, prosperity:-1 } }
    }
  ];
  return { ...randomPick(options), type:"policy" };
}

function marketCard(){
  const m = randomPick(MARKET_SHOCKS);
  return {
    title: m.title,
    prompt: m.prompt,
    A: { text: m.A, effects: m.effA },
    B: { text: m.B, effects: m.effB },
    type:"market"
  };
}

function bonusCard(){
  const b = randomPick(BONUSES);
  return {
    title: b.title,
    prompt: b.prompt,
    A: { text: b.A, effects: b.effA },
    B: { text: b.B, effects: b.effB },
    type:"bonus"
  };
}

function tradeCard(){
  return {
    title: "Trade Deal",
    prompt: "Trade can benefit both sides (comparative advantage). Accept a trade deal?",
    A: { text: "Accept trade", effects: { gdp:+1, prosperity:+1 } },
    B: { text: "Decline trade", effects: { prosperity:-1 } },
    type:"trade"
  };
}

function riskCard(){
  return {
    title: "Investment Risk",
    prompt: "You can take a risk for a potential reward.",
    A: { text: "Take the risk (coin flip)", effects: {}, delayed: { inTurns:1, rng:true } },
    B: { text: "Play safe", effects: { prosperity:+1, cash:+50 } },
    type:"risk"
  };
}

function startCard(){
  return {
    title: "Start",
    prompt: `Welcome! To win: reach Finish AND Prosperity Score ‚â• ${SETTINGS.prosperityToWin}.`,
    A: { text: "Begin with a smart plan (+cash buffer)", effects: { cash:+100, prosperity:+1 } },
    B: { text: "Go aggressive early (+GDP, +inflation)", effects: { gdp:+1, inflation:+1 } },
    type:"start"
  };
}

function finishCard(){
  return {
    title: "Finish",
    prompt: "You reached the finish line. Do you qualify to win?",
    A: { text: "Check Prosperity Score", effects: {} },
    B: { text: "Stabilize (lower inflation & unemployment)", effects: { inflation:-1, unemp:-1, cash:-100 } },
    type:"finish"
  };
}

function cardForLanding(tileIndex){
  const t = state.boardTypes[tileIndex];
  if(t==="start") return startCard();
  if(t==="finish") return finishCard();
  if(t==="decision") return { ...decisionCardFor(tileIndex), type:"decision" };
  if(t==="quiz") return quizCard();
  if(t==="policy") return policyCard();
  if(t==="market") return marketCard();
  if(t==="trade") return tradeCard();
  if(t==="bonus") return bonusCard();
  if(t==="risk") return riskCard();
  return { ...decisionCardFor(tileIndex), type:"decision" };
}

/* =========================
   TURN MODAL (center question)
   ========================= */
function openTurnModal({ playerName, tileIndex, tileType, card }){
  turnBackdrop.style.display = "flex";

  const typeMeta = TILE_LABEL[tileType] || { icon:"‚ùì", name:"Decision" };
  turnWhoTag.textContent = `${playerName} ‚Ä¢ Tile #${tileIndex}`;
  turnTypeTag.textContent = `${typeMeta.icon} ${typeMeta.name}`;

  turnMini1.textContent = `Goal: Prosperity ‚â• ${SETTINGS.prosperityToWin}`;
  turnMini2.textContent = `Finish tile: #${SETTINGS.finishTile}`;

  turnCardTitle.textContent = card.title;
  turnCardPrompt.textContent = card.prompt;

  turnChoices.innerHTML = "";

  const mkChoice = (which) => {
    const c = card[which];
    const btn = document.createElement("button");
    btn.className = "choiceBtn";
    const fxText = c.effects && Object.keys(c.effects).length ? formatEffects(c.effects) : "No immediate change";
    btn.innerHTML = `
      <strong>${which}) ${c.text}</strong>
      <span class="fx">Effects: ${fxText}</span>
    `;
    btn.onclick = ()=> choose(card, which);
    return btn;
  };

  turnChoices.appendChild(mkChoice("A"));
  turnChoices.appendChild(mkChoice("B"));

  turnFooterHint.textContent = "Pick A or B to continue.";
}

function closeTurnModal(){
  turnBackdrop.style.display = "none";
}

/* =========================
   CHOICE + WIN CHECK
   ========================= */
function checkWin(pIndex){
  const p = state.players[pIndex];
  const atFinish = state.positions[pIndex] >= SETTINGS.finishTile;
  if(!atFinish) return false;

  const score = prosperityScore(p);
  if(score >= SETTINGS.prosperityToWin){
    state.gameOver = true;
    rollBtn.disabled = true;
    closeTurnModal();
    setLastAction(`<strong>üèÜ ${p.name} wins!</strong> Prosperity ${score} (goal ‚â• ${SETTINGS.prosperityToWin}).`);
    logEntry({ icon:"üèÜ", title:`Winner: ${p.name}`, detail:`Prosperity ${score} (goal ‚â• ${SETTINGS.prosperityToWin})` });
    return true;
  } else {
    setLastAction(`${p.name} reached Finish, but Prosperity (${score}) is below ${SETTINGS.prosperityToWin}. Keep playing.`);
    logEntry({ icon:"‚ö†Ô∏è", title:`${p.name} reached Finish but didn‚Äôt qualify`, detail:`Prosperity ${score} < ${SETTINGS.prosperityToWin}` });
    return false;
  }
}

function choose(card, which){
  if(state.gameOver) return;

  const idx = state.currentPlayer;
  const p = state.players[idx];

  runQueuedEffects(p);

  const choice = card[which];

  applyEffects(p, choice.effects);

  if(choice.delayed){
    p.queue.push({ inTurns: choice.delayed.inTurns, effects: choice.delayed.effects, rng: !!choice.delayed.rng });
  }

  // cash stress penalty
  if(p.cash === 0){
    applyEffects(p, { prosperity:-1, unemp:+1 });
    logEntry({ icon:"üí∏", title:`${p.name} hit $0 cash`, detail:"Financial stress: -1 Prosperity, +1 Unemp" });
  }

  logEntry({ icon: which==="A" ? "üÖ∞Ô∏è" : "üÖ±Ô∏è", title:`${p.name} chose ${which}`, detail: choice.text });

  // update UI
  renderPlayersStrip();
  renderBoard();
  renderHeader("‚Äî");

  closeTurnModal();

  // win check
  if(!checkWin(idx)){
    nextTurn();
  }
}

function nextTurn(){
  if(state.gameOver) return;
  state.currentPlayer = (state.currentPlayer + 1) % state.playerCount;
  rollBtn.disabled = false;
  renderBoard();
  renderPlayersStrip();
  renderHeader("‚Äî");
  setLastAction(`It‚Äôs <strong>${state.players[state.currentPlayer].name}</strong>‚Äôs turn. Roll to continue.`);
}

/* =========================
   ROLL
   ========================= */
rollBtn.addEventListener("click", ()=>{
  if(state.gameOver || state.awaitingChoice) return;

  const roll = Math.floor(Math.random()*6)+1;
  const idx = state.currentPlayer;

  const oldPos = state.positions[idx];
  let newPos = oldPos + roll;
  if(newPos > SETTINGS.finishTile) newPos = SETTINGS.finishTile;
  state.positions[idx] = newPos;

  renderHeader(roll);
  renderBoard();

  const tileIndex = state.positions[idx];
  const tileType = state.boardTypes[tileIndex];
  const card = cardForLanding(tileIndex);

  logEntry({ icon:"üé≤", title:`${state.players[idx].name} rolled ${roll}`, detail:`Moved to tile #${tileIndex} (${TILE_LABEL[tileType].name}).` });
  setLastAction(`<strong>${state.players[idx].name}</strong> landed on <strong>${TILE_LABEL[tileType].name}</strong>. Answer the turn card.`);

  rollBtn.disabled = true;
  openTurnModal({ playerName: state.players[idx].name, tileIndex, tileType, card });
});

/* =========================
   RULES MODAL
   ========================= */
function openRules(){ rulesModal.style.display = "flex"; }
function closeRules(){ rulesModal.style.display = "none"; }

rulesBtn.addEventListener("click", openRules);
rulesCloseX.addEventListener("click", closeRules);
rulesCloseBtn.addEventListener("click", closeRules);
rulesStartBtn.addEventListener("click", closeRules);

rulesModal.addEventListener("click", (e)=>{ if(e.target === rulesModal) closeRules(); });

dontShowRules.addEventListener("change", ()=>{
  localStorage.setItem("econation_hide_rules", dontShowRules.checked ? "1" : "0");
});

/* =========================
   TURN MODAL CLOSE
   ========================= */
turnCloseX.addEventListener("click", closeTurnModal);
turnCancelBtn.addEventListener("click", closeTurnModal);
turnBackdrop.addEventListener("click", (e)=>{ if(e.target === turnBackdrop) closeTurnModal(); });

/* =========================
   NEW GAME / PLAYER COUNT
   ========================= */
function newGame(){
  const n = parseInt(playersSelect.value, 10);
  state = makeFreshState(n);

  logEl.innerHTML = "";
  logEntry({ icon:"‚úÖ", title:"Game ready", detail:`${n} player(s). Click Roll Dice to begin.` });

  rollBtn.disabled = false;
  renderBoard();
  renderPlayersStrip();
  renderHeader("‚Äî");
  setLastAction("Click <strong>Roll Dice</strong> to begin.");
}

newBtn.addEventListener("click", newGame);
playersSelect.addEventListener("change", newGame);

/* =========================
   INIT
   ========================= */
window.addEventListener("load", ()=>{
  state = makeFreshState(parseInt(playersSelect.value, 10));

  renderBoard();
  renderPlayersStrip();
  renderHeader("‚Äî");
  logEntry({ icon:"‚úÖ", title:"Game ready", detail:`${state.playerCount} player(s). Click Roll Dice to begin.` });

  // Rules auto-show unless hidden
  const hide = localStorage.getItem("econation_hide_rules") === "1";
  dontShowRules.checked = hide;
  if(!hide) openRules();
});
</script>

</body>
</html>
